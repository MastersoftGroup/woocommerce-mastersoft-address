/*@preserve mastersoft/woocommerce-mastersoft-address*/
jQuery(document).ready(function(e){function n(){d=function(){function e(e){try{var n=JSON.parse("["+e+"]");return"undefined"!=typeof n&&null!=n&&n.length?n[0]:{}}catch(n){return console.error("Error in parsing settings: "+n),console.warn("Possibly incorrect JSON format: "+e),null}}var n={username:void 0,password:void 0,url:"https://hosted.mastersoftgroup.com",AU:{locale:Harmony.AUSTRALIA,sot:Harmony.GNAF,featureOptions:{singleLineHitNumber:5,caseType:"TITLE"}},NZ:{locale:Harmony.NEW_ZEALAND,sot:Harmony.NZAD,featureOptions:{singleLineHitNumber:5,caseType:"TITLE",exposeAttributes:"1"}},INTL:{locale:Harmony.INTERNATIONAL,sot:"",featureOptions:{singleLineHitNumber:5,caseType:"TITLE"}},business:{enabled:!1,featureOptions:{country:"au",hits:5,caseType:"TITLE",bnStatus:"",taxStatus:"",state:["NSW","VIC","QLD","ACT","SA","WA","NT"],nameTypes:["MN","BN","TRD","OTN","LGL","DGR"]}},email:{enabled:!1,sot:"VE_ALL",options:[HraEmailJS.OPTIONS.FORMAT,HraEmailJS.OPTIONS.BLOCKLIST,HraEmailJS.OPTIONS.DOMAIN,HraEmailJS.OPTIONS.MAILSERVER,HraEmailJS.OPTIONS.MAILBOX]},phone:{enabled:!1}},t=php_vars.licenceKey,o=php_vars.url,a=php_vars.widgetLayout,r=php_vars.widgetOptions,i=php_vars.widgetOptionsAu,s=php_vars.widgetOptionsNz,l=php_vars.widgetOptionsEnhancedState,u=php_vars.widgetOptionsBusinessEnabled,d=php_vars.widgetOptionsBusiness,c=php_vars.widgetOptionsBusinessRetrieveName,p=php_vars.widgetOptionsEmailEnabled,f=php_vars.widgetOptionsEmail,y=php_vars.widgetOptionsPhoneEnabled,m=!1,b=v.setLicenseKey(t);if(b&&b.username&&b.password){if(m=!0,n.username=b.username,n.password=b.password,"undefined"!=typeof o&&o&&(n.url=o),"undefined"!=typeof a&&a&&(n.layout=e(a)||n.layout),"undefined"!=typeof f&&f&&(n.email=e(f)||n.email),n.email.enabled="yes"===p,n.phone.enabled="yes"===y,"undefined"!=typeof r&&r){var h=e(r)||{};Object.keys(h).forEach(function(e){var t=h[e];"sot"!==e&&(n.AU.featureOptions[e]=t,n.NZ.featureOptions[e]=t,n.INTL.featureOptions[e]=t,n.business.featureOptions[e]=t)})}if("undefined"!=typeof i&&i){var h=e(i)||{};Object.keys(h).forEach(function(e){var t=h[e];"sot"===e?n.AU.sot=t:n.AU.featureOptions[e]=t})}if("undefined"!=typeof s&&s){var h=e(s)||{};Object.keys(h).forEach(function(e){var t=h[e];"sot"===e?n.NZ.sot=t:n.NZ.featureOptions[e]=t})}if(n.enhancedStateHandling="yes"===l,n.business.enabled="yes"===u,n.business.displayRetrievedName="yes"===c,"undefined"!=typeof d&&d){var h=e(d)||{};Object.keys(h).forEach(function(e){n.business.featureOptions[e]=h[e]})}}return console.debug("Licence key is in "+(m?"VALID":"INVALID")+" format, URL: "+o+", Options: "+r+", AU Options: "+i+", NZ Options: "+s+", Email Enabled: "+p+", Email Options: "+f+", Phone Enabled: "+y+", Enhanced State: "+l+", Business Lookup Enabled: "+u+", Business Lookup Options: "+d),n}(),c=php_vars.nzRegionsValKey,e("#"+p+"country").data("val",e("#"+p+"country").val()),e("#"+f+"country").data("val",e("#"+f+"country").val())}function t(n,t){var a=e("#"+n+"country").val(),r=e("#"+n+"country").data("val");"undefined"!=typeof r&&r&&a!==r&&(s(n),l(n,"company"),i(n,t.business),o(a,n),u(n))}function o(n,t){function a(n,t,o,a,r,i,s,l){function u(n,t,o){if(t===Harmony.AUSTRALIA||t===Harmony.NEW_ZEALAND){var a=[o.streetNumber,o.street].filter(Boolean).join(" "),r=[o.buildingName,o.subdwelling,a,o.postal].filter(Boolean).join(", ");return void e("#"+n+"address_1").val(r)}var r=[o.attributes.Line1,o.attributes.Line2].filter(Boolean).join(", "),i=[o.attributes.Line3,o.attributes.Line4].filter(Boolean).join(", ");e("#"+n+"address_1").val(r),e("#"+n+"address_2").val(i)}function p(n,t,o){var a=o.attributes.City;e("#"+n+"city").val(a).change()}function f(n,t,o,a){function r(e){var n="";if(e.attributes&&e.attributes.regional_council_name){var t=e.attributes.regional_council_name.toUpperCase();t.endsWith(" REGION")&&(t=t.substring(0,t.length-7)),n=c[t.replace(/[^A-Za-z0-9]/g,"")]}return n}function i(n,t){e("#"+n+"state").val(t).change();var o=e("#"+n+"state").val();return"undefined"!=typeof o&&null!==o}if(t===Harmony.NEW_ZEALAND)return void i(n,r(o));var s=o.attributes.ProvinceName||o.attributes.ProvinceCode;if(!i(n,s)){var l=e("#"+n+"state option").filter(function(){return e(this).text()===s}).map(function(){return e(this).val()}).first();if("undefined"==typeof l||!l||!i(n,l)){if(!a)return void console.debug("Unable to select state: "+s);console.debug("Injecting retrieved state: "+s),e("#"+n+"state").append(e("<option>",{value:s,text:s})),i(n,s)||console.debug("Unable to select state: "+s)}}}function b(n,t,o){e("#"+n+"postcode").val(o.postcode)}if(!document.querySelector("#"+l+"address_1"))return void console.error("address_1 field not found");if(!document.querySelector("#"+l+"country"))return void console.error("country field not found");v.set({url:n,username:t,password:o,protocol:Harmony.CORS,locale:r,featureOptions:s});var h=HarmonyJS.addressLookup(_(l,m),document.querySelector("#"+l+"country"),i,{minLength:3,getIntlGeocode:!1,onRetrieve:function(e){u(l,r,e.onRetrieveItem),p(l,r,e.onRetrieveItem),f(l,r,e.onRetrieveItem,d.enhancedStateHandling),b(l,r,e.onRetrieveItem)}});y[l]=h.autocomplete}function r(t,a){if(null==document.querySelector("#"+t+"address_lookup")){var r='<p class="form-row address-field validate-required form-row-wide woocommerce-validated" id="'+t+'address_lookup_field" data-priority="50"><label for="'+t+'address_lookup" class="">Address lookup&nbsp;<abbr class="required" title="required">*</abbr></label><span class="woocommerce-input-wrapper"><input type="text" class="input-text " name="'+t+'address_lookup" id="'+t+'address_lookup" placeholder="Type an address to start searching..." data-placeholder=""></span></p>';e("#"+t+"country_field").after(e(r));var l=document.querySelector("#"+t+"address_lookup");e(l).val(i(t)),l.addEventListener("input",function(e){s(t)});var u=t+"show_address_fields_link";if(null==document.querySelector("#"+u)){var d=document.createElement("a");d.id=u,d.href="#",d.text="Can't find your address? Enter manually.",d.onclick=function(e){e.preventDefault(),a[t].disableOptimisation=!0,s(t);var r=document.querySelector("#"+t+"address_lookup_field");r&&r.parentNode.removeChild(r),o(n,t)},l.insertAdjacentElement("afterend",d)}}}function i(n){return[e("#"+n+"address_1").val(),e("#"+n+"address_2").val(),[e("#"+n+"city").val(),e("#"+n+"state").val(),e("#"+n+"postcode").val()].filter(Boolean).join(" ")].filter(Boolean).join(", ")}function u(e){var n=e+"add_businessname",t=document.querySelector("#"+n);if(!t){var o=document.createElement("p");o.classList.add("form-row"),o.classList.add("address-field"),o.classList.add("form-row-wide"),o.id=e+"add_businessname_field",t=document.createElement("a"),t.id=n,t.href="#",t.onclick=function(n){n.preventDefault(),b(e,"company_field")?g(e,"company_field"):(l(e,"company"),h(e,"company_field")),t.text=b(e,"company_field")?"Add business name":"Remove business name"},o.appendChild(t),document.querySelector("#"+e+"last_name_field").insertAdjacentElement("afterend",o)}t.text=b(e,"company_field")?"Add business name":"Remove business name"}function p(e){var n=document.querySelector("#"+e+"address_lookup_field");n&&n.parentNode.removeChild(n);var t=document.querySelector("#"+e+"add_businessname_field");t&&t.parentNode.removeChild(t)}function f(n,t,o){o&&t[n]&&"OPTIMISED"===t[n].layout&&!t[n].disableOptimisation?(""==e("#"+n+"company").val()&&h(n,"company_field"),setTimeout(function(){h(n,"address_1_field"),h(n,"address_2_field"),h(n,"city_field"),h(n,"state_field"),h(n,"postcode_field")},0),r(n,t),u(n)):(g(n,"company_field"),g(n,"address_1_field"),g(n,"address_2_field"),g(n,"city_field"),g(n,"state_field"),g(n,"postcode_field"),p(n))}function b(e,n){return"none"==document.querySelector("#"+e+n).style.display}function h(e,n){document.querySelector("#"+e+n).style.display="none"}function g(e,n){document.querySelector("#"+e+n).style.display=""}function _(e,n){return"OPTIMISED"!==n[e].layout||n[e].disableOptimisation?document.querySelector("#"+e+"address_1"):document.querySelector("#"+e+"address_lookup")}if(y[t]){y[t].destroy();try{delete y[t]}catch(e){console.debug("Error deleting autocomplete instance: "+e),y[id]=void 0}}var O,S,A;if(n){var E=d[n]||d.INTL;E&&(O=E.locale,S=E.sot,A=E.featureOptions)}var N=d.username,L=d.password,I=d.url;m[t]||(m[t]={disableOptimisation:!1},Object.assign(m[t],d.layout));var T=Boolean("undefined"!=typeof N&&N&&"undefined"!=typeof L&&L&&"undefined"!=typeof O&&O&&"undefined"!=typeof S&&(S||O===Harmony.INTERNATIONAL));f(t,m,T),T&&!m[t].disableOptimisation&&a(I,N,L,m,O,S,A,t)}function a(e,n){var t=document.querySelector("#"+e+"email");if("undefined"==typeof t||!t)return void console.warn("unable to setup email validation - element not found");var o={};Object.assign(o,n),o.enabled&&(o.onError=function(e){e&&e.length?console.error("Email validation error: "+e.join("\n")):console.error("Email validation error")},o.onValidating=function(e){console.debug('Validating "'+e+'"...')},o.onValidated=function(e){console.debug("Email validated - "+(e.isValid?"VALID":"INVALID"))},v.set({url:php_vars.url,protocol:Harmony.CORS}),v.setLicenseKey(php_vars.licenceKey),HraEmailJS.emailValidation(t,o))}function r(n,t){var o=document.querySelector("#"+n+"phone");if("undefined"==typeof o||!o)return void console.warn("unable to setup phone validation - element not found");var a={};Object.assign(a,t),a.enabled&&(o.placeholder="Must be in international format e.g +61 XXX XXXX",a.onError=function(e){console.error("Phone validation error"),e&&e.length&&console.debug(JSON.stringify(e,null,2))},a.onValidating=function(e){console.debug('Validating "'+e+'"...')},a.onValidated=function(e){console.debug("Phone validated - "+e.status),console.debug(JSON.stringify(e,null,2))},a.getCountry=function(){return e("#"+n+"country").val()||""},v.set({url:php_vars.url,protocol:Harmony.CORS}),v.setLicenseKey(php_vars.licenceKey),HraPhoneJS.phoneValidation(o,a))}function i(e,n){if(n.enabled){var t=e+"company";if(y[t]){y[t].destroy();try{delete y[t]}catch(e){console.debug("Error deleting autocomplete instance: "+e),y[t]=void 0}}var o=document.querySelector("#"+t);if("undefined"==typeof o||!o)return void console.warn("unable to setup company name autocomplete - element not found");var a=document.querySelector("#"+e+"country");if("undefined"!=typeof a&&a||(console.debug("country element not found, assume default country (AU)"),a={value:Harmony.AUSTRALIA}),a.value.toUpperCase()!==Harmony.AUSTRALIA.toUpperCase())return void console.debug("Business lookup not supported for country: "+a.value);var r={};Object.assign(r,n.featureOptions),r.country=a,Array.isArray(r.state)&&(r.state={value:r.state.join(",")}),Array.isArray(r.nameTypes)&&(r.nameTypes={value:r.nameTypes.join(",")});var i=n.displayRetrievedName;r.onRetrieve=function(e){i||(o.value=e.name)},v.set({url:php_vars.url,protocol:Harmony.CORS}),v.setLicenseKey(php_vars.licenceKey),y[t]=HraBusinessJS.businessAutoComplete(o,r).autocomplete}}function s(e){l(e,"address_1"),l(e,"address_2"),l(e,"city"),l(e,"state"),l(e,"postcode")}function l(n,t){e("#"+n+t).val("").change()}function u(n){d&&d.phone&&d.phone.enabled&&e("#"+n+"phone").change()}console.debug("Mastersoft Address Autocomplete is ready."),console.debug("Using jquery "+e.fn.jquery);var d,c,p="billing_",f="shipping_",y={},m={},v=function(){var e={initCounter:0};return{setLicenseKey:function(n){if("undefined"!=typeof n&&n&&n.indexOf(":")>0){e.initCounter++;var t=n.indexOf(":");return e.username=n.substring(0,t),e.password=n.substring(t+1,n.length),{username:e.username,password:e.password}}return null},set:function(n){e.initCounter++,Object.assign(e,n)},initialize:function(){return e.initCounter<=0?(console.debug("Harmony JS client attribute not set."),!1):"undefined"==typeof e.url?(console.error("Harmony JS client attribute not set: environment url"),!1):"undefined"==typeof e.username||"undefined"==typeof e.password?(console.error("Harmony JS client attribute not set: login credential"),!1):"undefined"==typeof e.protocol?(console.error("Harmony JS client attribute not set: protocol"),!1):(Harmony.useEnv(e.url),Harmony.useProtocol(Harmony.CORS),Harmony.init(e.username,e.password,e.locale),Harmony.useFeatureOptions(e.featureOptions),e.initCounter=0,!0)}}}();n(),e("#"+p+"country").length&&o(e("#"+p+"country").val(),p),e("#"+f+"country").length&&o(e("#"+f+"country").val(),f),e("#"+p+"email").length&&a(p,d.email),e("#"+f+"email").length&&a(f,d.email),e("#"+p+"phone").length&&r(p,d.phone),e("#"+f+"phone").length&&r(f,d.phone),e("#"+p+"company").length&&i(p,d.business),e("#"+f+"company").length&&i(f,d.business),v.initialize(),e("#billing_country").change(function(){t(p,d),e(this).data("val",e(this).val())}),e("#shipping_country").change(function(){t(f,d),e(this).data("val",e(this).val())})});